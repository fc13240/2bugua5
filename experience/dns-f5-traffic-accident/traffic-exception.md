# 记一次网站访问异常

还是一个周三的中午，正吃着午饭，二货突然说高层群里报线上异常，APP访问接口失败！赶紧拿手机试，真是
又挂了！因为前几周刚出过线上大量超时的事故，心想完了，不会又是nodejs超时吧。和二货回到公司，再看
现象，又和之前的超时有点区别：之前超时是APP里刷新很久，最后报异常；这次是刷新立即报请求失败。莫不是CDN
出问题了？



## CDN异常？

打开PC端页面，发现动态请求(需要回源)响应很慢，但是能成功返回；静态资源(缓存在CDN)大量请求失败，返回
`http status code` 包含 **533**， **564**， **532** 等。

根据我了解到的，我们服务器 **所有请求** 都会经过CDN，只是 **动态请求** 会回源到我们服务器；静态资源
缓存在CDN上。因此，看上面的现象，感觉是 **CDN异常** 了，因为凡是回源到我们自己server的请求都是OK
的，而直接走CDN的静态资源却大量异常。

这时候我想法很简单，既然回源到自己server没问题，那 **所有请求不走CDN，直接把域名指向我们自己服务器**
应该能解决了。事实证明我还是 too young 。OP告诉我，不能把域名指向我们真实服务器，那样 **会暴露服务器
的公网IP，容易被人攻击** 。纳尼？还有这个说法么，我确实还不知道……

后来我查了一下，原来CDN不仅仅是我理解的那样，缓存静态资源，加速网站访问。还有什么 “高防CDN”，能帮助
全站抵抗DDOS请求，过滤掉一些恶意流量。难怪刚来公司时，听说我们全站都走的CDN，当时很不理解，现在终于
解决了那时的疑惑了。

OK，既然怀疑CDN有问题，OP同学还是 **强制所有请求，都经过CDN回源** ，理论上这样应该是能修复的。


## 机房网络线路故障？

在操作上面 **强制所有请求，经过CDN回源** 的同时，OP同学还把 **内网DNS上，我们自己的域名，直接解析到F5设备**，
期望自己内网请求，不经过CDN，直接到达我们自己服务器，能够快一些吧。然而，这一切似乎并没有太多卵用:(

因为我这时候在公司内网，访问我们网站直接请求到了F5，不经过CDN，刷新PC页面，大量的 **请求拒绝连接**，
甚至页面请求都经常被拒绝！！

There must be something wrong!!

嗯，再想，确实有问题，之前网站流量大的时候(其实也不算大)，后端服务扛不住，**为了服务稳定**，OP同学在
F5上做了限流，貌似 **单个域名** 限流为1000(这里也有我之前的误解，原来以为1000是说到达F5的所有请求，
现在才知道，原来是针对不同域名设置的)。所以拒绝连接就正常了，因为现在 **所有请求** 都回源到了F5，
包括大量的静态资源，想想我们一个页面，都有四五十个静态资源，那肯定会触发F5的限流。


## 备用机房？

显然，**全部流量回源到F5**，会触发F5限流，还是不行。

这时候，终于又知道了一件事情，我们有个备用机房！原来，我们线上是有2个机房的啊(热泪盈眶)，这么机密的事情，
居然因为这次事故，被暴露给我们底层码农了。

OK，第一次尝试 **全部流量经CDN回源到机房A** ，出发了机房A的F5限流；OP同学果断把 **部分流量经CDN回源
到备用机房B**，备用机房用 `nginx`(不是F5) 来接收。

据OP同学说，是把 **PC端流量，即 www 的二级域名** 都切到了备用机房B；移动端流量还是去机房A。

现在访问PC站，走备用机房的nginx，貌似还行；有点记不清，当时有没有测试APP上的访问了……稍微有点尴尬:(

哦，貌似想起一点，当时我访问 m 站，因为我在内网，所以内网DNS是直接把域名解析到了机房A的F5上，还是很慢！！
而且，请求任意的图片，在chrome里观察network时间轴，TTFB 总是在 54秒 左右！！

TTFB居然要54秒，而且还是一个静态的图片，实在想不到这么多时间是花在哪个地方了……我现在请求是直接到达的
机房F5，没有经过CDN，这锅CDN是没法背了。但应该不是F5流量大导致的，如果超出阈值，会直接拒绝连接。
那是怎么个意思呢，机房前面的网络出问题了么，被挖掘机挖掉一半莫不是？应该不是F5的什么问题吧，毕竟几十万
一台的高级货。
