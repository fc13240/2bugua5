# webp图片实战


##　上webp难于上晴天

之前关于`webp图片`上线，调研了一个通过 `服务端内容协商(server content negotiation)` 的技术
实现方案，具体见 [nginx webp 响应式](https://github.com/sophister/2bugua5/blob/master/experience/nginx-webp-auto-responsive/nginx-webp-responsive.md) 。但是这个方案，上线起来成本比较大，需要推动OP，升级`nginx`，安装`lua`脚本的相关依赖，
并且可能需要单独的`图片服务器`来专门负责处理图片，短期内想上线，几乎没希望……


## 没条件上，就创造条件

但是，`webp`不能成功在我司上线，是完全不能忍的。因此，就有了本次的小成本上线方案。

可能有同学会疑惑，为什么非得上`webp`？无他，为用户省流量，为公司省成本，为页面提速度。既然都提到
了`H5页面提速`这个话题，不妨说下接下来的想法，主要从这两个方面来提速，也可以说是分两步走吧：

1. 对各种图片资源，png/jpg 等，`webp`化
2. JS/CSS 文件，`localstorage`化，就是把JS、CSS都存储在浏览器`localstorage`里

本篇文章，说的就是第一步，图片`webp化`。

`webp`的介绍和实战文章，网上已经很多了，优点就是缩小图片文件大小，缩短图片下载时间，最终缩短页面
渲染时间，提升用户体验。看了些晚上图片，大多数都说针对 jpg/png 图片转换成 `webp` 后，文件大小大概
降低 `20% - 30%`。下面是我把本周上线的一个活动页面图片，都是经过UE压缩过的 `jpg图片`，拿来通过 `cwebp`工具转换后，对比的结果：

![jpg转webp随机结果](./1.png)

![jpg各个图片大小](./1.1.png)

![webp各个图片大小](./1.2.png)

可以看出，随便一个活动页面，图片从jpg转换成`webp`之后，整体大小几乎只有`jpg`的 **1/10** ！当然，这应该
和我们设计给的图片本身的压缩有关，但至少从我们公司来看，图片还是很有优化的必要的。

下面是我通过 [node-sharp](https://github.com/lovell/sharp) 这个`node包`，对另外一个活动
的两个图片，随机转换成`webp`的结果：

![png/jpg/webp](./2.png)

可以看出，`jpg`到`webp`，文件大小缩小 **50%** ；`png`到`webp`，文件大小缩小 **70%** 。

再次说明：**上述结果，只是我本次使用图片压缩出来的结果，并不是说webp能压缩这么多！！** 。


## webp上线方案
